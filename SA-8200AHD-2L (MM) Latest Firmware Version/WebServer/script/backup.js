var g_backupSelItem=null;var g_getProgressTimer=0;var g_preFileIndex=0;var g_backupBackground=false;var g_fileInfoArray=null;var g_backupPath="";var g_backupTip="";var g_xmlDocForProgress=createXMLDoc();function GotoBackupPage(){var a=document.getElementById("div_main_menu");var b=document.getElementById("div_backup_body");if(g_mainMenuItem==3){HintSave(-1)}g_mainMenuItem=2;selected(g_mainMenuItem);HideDIVs();a.style.display="";a.visibility="visible";b.style.display="";b.visibility="visible";g_xmlhttp.open("get","body_html/body_backup.html",false);StartWait();SafeHttpSend(g_xmlhttp,null);OnReceiveBackup()}function OnReceiveBackup(){var b;if(g_xmlhttp.readyState!=4){StopWait();return}if(g_backupBackground){if(g_getProgressTimer!=0){var a=document.getElementById("backup_backup_buttom");var d=document.getElementById("backup_stopbackup_buttom");a.style.display="none";d.style.display=""}else{g_backupBackground=false}StopWait()}else{var h=document.getElementById("div_backup_body");h.innerHTML=g_xmlhttp.responseText;EdgeCtrl(h,32);var g=new Array("ctrl_calendar.js","ctrl_time.js","ctrl_list.js","ctrl_generator.js","playback.js");LoadMultiJS(g,OnLoadBackupPage);g_fileInfoArray=new Array(0);g_curListPageIndex=0;var c=document.getElementById("backup_browse_path");c.value=g_backupPath}var f=/msie/i.test(navigator.userAgent);if(!f){var e=h.offsetHeight+40;document.getElementById("work_area").style.height=e+"px"}}function OnLoadBackupPage(){var o=document.getElementById("div_backup_channel");GenCheckGroup(o,false,g_TotalChannelList,"backup_channel_index");var a=new Date();var j=a.getFullYear()+"-"+AlignTime(a.getMonth()+1)+"-"+AlignTime(a.getDate());var g=document.getElementsByName("backup_channel_index");for(var h=0;h<g.length;h++){g[h].checked=true}UpdateCheckItems(o);var f=document.getElementsByName("backup_item");for(h=0;h<f.length;h++){f[h].style.display="none"}var m=document.getElementById("info_backup_sdate_span");var p=document.getElementById("info_backup_edate_span");var d=document.getElementById("info_backup_stime_span");var n=document.getElementById("info_backup_etime_span");var c=new DateTicker("backup_start_dateticker");m.innerHTML=c;m.dateName="backup_start_dateticker";var l=new DateTicker("backup_end_dateticker");p.innerHTML=l;p.dateName="backup_end_dateticker";var b=new DateBox("backup_time",false,true);d.innerHTML=b;d.dateName="backup_time";var k=new DateBox("backup_end_time",false,true);n.innerHTML=k;n.dateName="backup_end_time";var e=new Date();e=e.getFullYear()+"-"+AlignTime(e.getMonth()+1)+"-"+AlignTime(e.getDate());DateTicker.all[m.dateName].setValue(e);DateTicker.all[p.dateName].setValue(e);DateBox.all[d.dateName].setValue(new Array("00","00","00"));DateBox.all[n.dateName].setValue(new Array("23","59","59"));ApplyXmlLang("backup.xml");StopWait()}function FileInfo(c,b,a,d){this.channel=c;this.startTime=b;this.endTime=a;this.fileIndex=d;this.status=""}function BrowseFolder(b){var a=WebClient.BrowseForFolder(b.value);if(b.value!=a){g_bChange=true}b.value=a;return a}function BrowseFolder_NoSave(b){var a=WebClient.BrowseForFolder(b.value);b.value=a;return a}function SetBackupPath(b){if((b==null)||(b=="")){window.alert(backup_path_empty_tip);return false}var e="<request>\r\n";e+='<command name="'+STR_LM_SET_BACKUP_PATH+'">\r\n';e+="<"+STR_BACKUP_PATH+">"+b+"</"+STR_BACKUP_PATH+">\r\n";e+="</command>\r\n";e+="</request>\r\n";var a=WebClient.ExcuteLocalCmd(e);if(g_xmlDoc!=null){delete g_xmlDoc;g_xmlDoc=null}g_xmlDoc=FormatToXmlDOM(a);g_xmlDoc.async=false;var d=g_xmlDoc.documentElement.getElementsByTagName("command");if(d.length>0){var c=d[0].getElementsByTagName("command");if(c.length>0){if(c[0].childNodes[0].nodeValue=="0"){window.alert(str_folder_not_exist);return false}}}return true}function SearchInBackup(){StartWait();RequestBackupFileInfo()}function RequestBackupFileInfo(k,b){var u=document.getElementById("info_backup_sdate_span");var n=document.getElementById("info_backup_edate_span");var a=document.getElementById("info_backup_stime_span");var e=document.getElementById("info_backup_etime_span");var l=false;var t=new Array(64);for(m=0;m<64;m++){t[m]="0"}var p=document.getElementsByName("backup_channel_index");for(m=0;m<p.length;m++){if(p[m].checked){t[m]="1";l=true}}if(!l){window.alert(backup_channel_select_tip);StopWait();return}var c=DateTicker.all[u.dateName].getValue();var f=DateTicker.all[n.dateName].getValue();var k=c+" "+DateBox.all[a.dateName].getValue();var b=f+" "+DateBox.all[e.dateName].getValue();if(b<=k){window.alert(etime_small_than_stime_tip);StopWait();return}g_fileInfoArray=new Array();g_backupSelItem=new Array();g_curListPageIndex=0;ShowBackupFileList(g_curListPageIndex);var q=GenReqDataInfoXML(1,t.join(""),k,b,1,15);var d=WebClient.ExcuteCmd(q);if(d==""){StopWait();return false}if(g_xmlDoc!=null){delete g_xmlDoc;g_xmlDoc=null}g_xmlDoc=FormatToXmlDOM(d);g_xmlDoc.async=false;var o=g_xmlDoc.documentElement.getElementsByTagName("command");if(o.length==0){StopWait();return false}if(o[0].attributes.getNamedItem("name").nodeValue!=STR_REPLY_SEARCH_TIME){StopWait();return false}var h=0;var g=0;var j=o[0].getElementsByTagName("time_section");for(var m=0;m<j.length;m++){var s=j[m].getElementsByTagName(STR_CHANNEL)[0].childNodes[0].nodeValue;h=j[m].getElementsByTagName(STR_START_TIME)[0].childNodes[0].nodeValue;g=j[m].getElementsByTagName(STR_END_TIME)[0].childNodes[0].nodeValue;h=parseInt(h,10);g=parseInt(g,10);var r=new Date();r.setTime(h*1000);h=DateToString(r);r.setTime(g*1000);g=DateToString(r);g_fileInfoArray[m]=new FileInfo(s,h,g,m);g_backupSelItem[m]=false}StopWait();ShowBackupFileList(g_curListPageIndex)}function ShowBackupFileList(a){var c=document.getElementById("file_list");var e=document.getElementById("backup_list_page");var f=document.getElementsByName("backup_item");var g=/msie/i.test(navigator.userAgent);if((g_fileInfoArray.length<=a*20)&&a!=0){return false}for(itemIdx=a*20;itemIdx<(a+1)*20;itemIdx++){var b=c.rows[itemIdx%20+1].cells;if(itemIdx>=g_fileInfoArray.length){f[itemIdx%20].style.display="none";if(g){b[1].innerText=" ";b[2].innerText=" ";b[3].innerText=" ";b[4].innerText=" "}else{b[1].textContent=" ";b[2].textContent=" ";b[3].textContent=" ";b[4].textContent=" "}}else{if(!(g_authority.authority&16)||!((1<<g_fileInfoArray[itemIdx].channel)&g_authority.authBackup)){f[itemIdx%20].disabled=true;g_fileInfoArray[itemIdx].status=str_no_auth}else{if(!g_backupBackground){f[itemIdx%20].disabled=false}}f[itemIdx%20].style.display="";if(g){b[1].innerText=parseInt(g_fileInfoArray[itemIdx].channel,10)+1;b[2].innerText=g_fileInfoArray[itemIdx].startTime;b[3].innerText=g_fileInfoArray[itemIdx].endTime;if(g_fileInfoArray[itemIdx].status.length<20){b[4].innerText=g_fileInfoArray[itemIdx].status}}else{b[1].textContent=parseInt(g_fileInfoArray[itemIdx].channel,10)+1;b[2].textContent=g_fileInfoArray[itemIdx].startTime;b[3].textContent=g_fileInfoArray[itemIdx].endTime;if(g_fileInfoArray[itemIdx].status.length<20){b[4].textContent=g_fileInfoArray[itemIdx].status}}f[itemIdx%20].checked=g_backupSelItem[itemIdx]}var d=Math.ceil(g_fileInfoArray.length/20);if(d<=0){e.innerHTML="0/0"}else{e.innerHTML=a+1+"/"+d}}return true}function Backup_SelectAll(){if(g_backupSelItem==null){return}for(var a=0;a<g_backupSelItem.length;a++){if(!(g_authority.authority&16)||!((1<<g_fileInfoArray[a].channel)&g_authority.authBackup)){g_backupSelItem[a]=false}else{g_backupSelItem[a]=true}}ShowBackupFileList(g_curListPageIndex)}function Backup_InvertSelection(){if(g_backupSelItem==null){return}UpdateSelection();for(var a=0;a<g_backupSelItem.length;a++){if(!(g_authority.authority&16)||!((1<<g_fileInfoArray[a].channel)&g_authority.authBackup)){g_backupSelItem[a]=false}else{g_backupSelItem[a]=!g_backupSelItem[a]}}ShowBackupFileList(g_curListPageIndex)}function UpdateSelection(){var b=document.getElementsByName("backup_item");for(var a=0;a<20;a++){if(a+g_curListPageIndex*20<g_backupSelItem.length){g_backupSelItem[a+g_curListPageIndex*20]=b[a].checked}}}function StartBackup(){var b=document.getElementById("backup_browse_path");var o=document.getElementsByName("backup_item");var s=document.getElementById("info_backup_sdate_span");var n=document.getElementById("info_backup_edate_span");var a=document.getElementById("info_backup_stime_span");var e=document.getElementById("info_backup_etime_span");var r=document.getElementById("backup_stopbackup_buttom");var f=document.getElementById("backup_backup_buttom");g_backupTip="";if(!SetBackupPath(b.value)){return}if(g_backupSelItem==null){window.alert(str_no_data_tip);return}UpdateSelection();var p=0;for(var m=0;m<g_backupSelItem.length;m++){if(g_backupSelItem[m]){p++}}if(p==0){window.alert(backup_file_select);return}var j="<request>\r\n";j+='<command name="'+STR_LM_START_BACKUP+'">\r\n';var q=0;var d=DateTicker.all[s.dateName].getValue();var g=DateTicker.all[n.dateName].getValue();var l=d+" "+DateBox.all[a.dateName].getValue();var c=g+" "+DateBox.all[e.dateName].getValue();for(m=0;m<g_fileInfoArray.length;m++){if(g_backupSelItem[m]){var k=g_fileInfoArray[m].startTime;k=k>l?k:l;var h=g_fileInfoArray[m].endTime;h=h<c?h:c;if(k>=h){g_backupSelItem[m]=false;if((m/20)==g_curListPageIndex){o[m%20].checked=false}continue}q++;j+="<"+STR_TIME_SECTION+">\r\n";j+="<"+STR_CHANNEL+">"+g_fileInfoArray[m].channel+"</"+STR_CHANNEL+">\r\n";j+="<"+STR_START_TIME+">"+k+"</"+STR_START_TIME+">\r\n";j+="<"+STR_END_TIME+">"+h+"</"+STR_END_TIME+">\r\n";j+="<"+STR_FILE_INDEX+">"+g_fileInfoArray[m].fileIndex+"</"+STR_FILE_INDEX+">\r\n";j+="</"+STR_TIME_SECTION+">\r\n"}}j+="</command>\r\n";j+="</request>\r\n";if(q==0){window.alert(str_no_data_tip);return}WebClient.ExcuteLocalCmd(j);g_preFileIndex=-1;g_getProgressTimer=setTimeout("GetFileBackupProgress()",100);r.style.display="";f.style.display="none";g_backupBackground=true;SetBackupState(true)}function StopBackup(f){var c=document.getElementById("file_list");var d=document.getElementById("div_backup_body");var e="<request>\r\n";e+='<command name="'+STR_LM_STOP_BACKUP+'">\r\n';e+="</command>\r\n";e+="</request>\r\n";WebClient.ExcuteLocalCmd(e);var b=document.getElementById("backup_stopbackup_buttom");var a=document.getElementById("backup_backup_buttom");b.style.display="none";a.style.display="";clearTimeout(g_getProgressTimer);g_getProgressTimer=0;if(f){g_fileInfoArray[g_preFileIndex].status=str_cancelled;if(Math.floor(g_preFileIndex/20)==g_curListPageIndex){c.rows[(g_preFileIndex%20)+1].cells[4].innerHTML=g_fileInfoArray[g_preFileIndex].status}}if(d.style.display!="none"){g_backupBackground=false}if(g_backupTip!=""){window.alert(g_backupTip)}SetBackupState(false)}function GetFileBackupProgress(){var j=document.getElementsByName("backup_item");var i=document.getElementById("file_list");if(!g_backupBackground){clearTimeout(g_getProgressTimer);g_getProgressTimer=0;return}var p="<request>\r\n";p+='<command name="'+STR_LM_BACKUP_PROGRESS+'"></command>\r\n';p+="</request>\r\n";var e=WebClient.ExcuteLocalCmd(p);if(g_xmlDocForProgress!=null){delete g_xmlDocForProgress;g_xmlDocForProgress=null}g_xmlDocForProgress=FormatToXmlDOM(e);g_xmlDocForProgress.async=false;var f=g_xmlDocForProgress.documentElement.getElementsByTagName("command");if((f.length!=0)&&(f[0].attributes.getNamedItem("name").nodeValue==STR_LM_BACKUP_PROGRESS)&&(f[0].childNodes.length!=0)){var h=f[0].getElementsByTagName(STR_FILE_INDEX)[0].childNodes[0].nodeValue;h=parseInt(h,10);var a=f[0].getElementsByTagName(STR_BACKUP_PROGRESS)[0].childNodes[0].nodeValue;a=parseInt(a,10);if(a==200){g_backupTip=str_stream_no_capability_bk;for(var l=g_preFileIndex+1;l<=h;l++){if(g_backupSelItem[l]){g_fileInfoArray[l].status=str_failed_for_busy;g_backupSelItem[l]=false;j[l%20].checked=false;g_backupTip=str_stream_no_capability_bk}}Backup_ToPage(Math.floor(h/20));i.rows[(h%20)+1].cells[4].innerHTML=g_fileInfoArray[h].status;StopBackup(false);return}if(g_preFileIndex!=h){if(g_preFileIndex!=-1){g_fileInfoArray[g_preFileIndex].status=str_finished;if(Math.floor(g_preFileIndex/20)==g_curListPageIndex){i.rows[(g_preFileIndex%20)+1].cells[4].innerHTML=g_fileInfoArray[g_preFileIndex].status}g_backupSelItem[g_preFileIndex]=false;j[g_preFileIndex%20].checked=false}for(var l=g_preFileIndex+1;l<h;l++){if(g_backupSelItem[l]){g_fileInfoArray[l].status=str_failed_for_busy;g_backupSelItem[l]=false;j[l%20].checked=false;g_backupTip=str_stream_no_capability_bk}}g_preFileIndex=h;Backup_ToPage(Math.floor(h/20))}if(a==100){g_fileInfoArray[h].status=str_finished;if(Math.floor(h/20)==g_curListPageIndex){i.rows[(h%20)+1].cells[4].innerHTML=g_fileInfoArray[h].status}g_backupSelItem[h]=false;j[h%20].checked=false;for(var q=0;q<g_backupSelItem.length;q++){if(g_backupSelItem[q]){break}}if(q==g_backupSelItem.length){StopBackup(false);return}}else{var o=Math.floor(i.rows[(h%20)+1].cells[4].offsetWidth*a/100-1);var n=i.rows[(h%20)+1].cells[4].offsetHeight-4;var g=/msie/i.test(navigator.userAgent);if(g){g_fileInfoArray[h].status="<div id='backup_progress_001' style='position:absolute; background-color:#8080ff;z-index:0;left:0px;width:"+o+"px;'></div>";g_fileInfoArray[h].status+="<div id='backup_progress_002' style='position:absolute;z-index:1;left:0px;width:"+i.rows[0].cells[4].offsetWidth+"px;'>"+a+"%</div>";if(Math.floor(h/20)==g_curListPageIndex){i.rows[(h%20)+1].cells[4].innerHTML=g_fileInfoArray[h].status;var d=document.getElementById("backup_progress_001");var c=document.getElementById("backup_progress_002");var m=i.rows[(h%20)+1].cells[4].offsetLeft;var b=i.rows[(h%20)+1].cells[4].offsetParent;while(b!=d.offsetParent){m+=b.offsetLeft;b=b.offsetParent}d.style.left=m-d.offsetLeft+2;c.style.left=m-c.offsetLeft+2;d.style.top=d.offsetTop+2;c.style.top=c.offsetTop+2}}else{g_fileInfoArray[h].status="<div id='backup_progress_001' style='position:absolute; background-color:#8080ff;z-index:0;left:0px;width:"+o+"px;height:"+n+"px;'></div>";g_fileInfoArray[h].status+="<div id='backup_progress_002' style='position:absolute;z-index:1;left:0px;width:"+i.rows[0].cells[4].offsetWidth+"px;height:"+n+"px;'>"+a+"%</div>";if(Math.floor(h/20)==g_curListPageIndex){i.rows[(h%20)+1].cells[4].innerHTML=g_fileInfoArray[h].status;var d=document.getElementById("backup_progress_001");var c=document.getElementById("backup_progress_002");var m=i.rows[(h%20)+1].cells[4].offsetLeft;var b=i.rows[(h%20)+1].cells[4].offsetParent;while(b!=d.offsetParent){m+=b.offsetLeft;b=b.offsetParent}d.style.left=(m-d.offsetLeft+2)+"px";c.style.left=(m-c.offsetLeft+2)+"px";d.style.top=(d.offsetTop-8)+"px";c.style.top=(c.offsetTop-8)+"px"}}}}g_getProgressTimer=setTimeout("GetFileBackupProgress()",100)}function Backup_ToFirstPage(){if(g_backupSelItem==null){return}UpdateSelection();g_curListPageIndex=0;ShowBackupFileList(g_curListPageIndex)}function Backup_ToLastPage(){if(g_backupSelItem==null){return}UpdateSelection();g_curListPageIndex=Math.floor(g_backupSelItem.length/20);ShowBackupFileList(g_curListPageIndex)}function Backup_ToNextPage(){if(g_backupSelItem==null){return}UpdateSelection();if(g_curListPageIndex==Math.floor(g_backupSelItem.length/20)){return}g_curListPageIndex++;ShowBackupFileList(g_curListPageIndex)}function Backup_ToPrevPage(){if(g_backupSelItem==null){return}UpdateSelection();if(g_curListPageIndex==0){return}g_curListPageIndex--;ShowBackupFileList(g_curListPageIndex)}function Backup_ToPage(a){UpdateSelection();g_curListPageIndex=a;ShowBackupFileList(g_curListPageIndex)}function SetBackupState(e){var f=document.getElementById("div_backup_body");var c=document.getElementById("backup_search_button");var b=document.getElementById("backup_stopbackup_buttom");var a=document.getElementById("backup_backup_buttom");if(f.innerHTML!=""){var g=f.getElementsByTagName("input");for(var d=0;d<g.length;d++){g[d].disabled=e}c.disabled=e;b.disabled=false;a.disabled=false}};